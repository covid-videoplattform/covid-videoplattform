---

- hosts: bastion_servers
  tasks:
    - name: add other ips and hostnames to /etc/hosts
      lineinfile:
        path: /etc/hosts
        regexp: "{{ item }}"
        line: "{{ hostvars[item].internal_ip }} {{ item }}"
      with_items: "{{ groups.all }}"

- hosts: reverse_proxies
  roles:
    - role: nginx
    - role: certificate
      vars:
        certificate_name: "{{ jitsi_domain }}"
        certificate_directory: /etc/ssl
        certificate_key_usage:
          - digitalSignature
          - keyEncipherment
        certificate_extended_key_usage:
          - serverAuth
        certificate_common_name: "{{ jitsi_domain }}"
    - role: reverse-proxy

- hosts: frontend_servers
  roles:
    - role: jitsi-meet-web

- hosts:
  - prosody_servers
  roles:
    - role: jitsi-prosody

- hosts:
  - jicofo_servers
  roles:
    - role: jicofo

- hosts:
  - videobridges
  roles:
    - role: jitsi-videobridge

- hosts:
  - all
  tasks:
   - name: add markus ssh pub key
     authorized_key:
       user: root
       state: present
       key: "{{ lookup('file', '.ssh/markus.pub') }}"

   - name: add brian ssh pub key
     authorized_key:
       user: root
       state: present
       key: "{{ lookup('file', '.ssh/brian.pub') }}"

   - name: add florian ssh pub key
     authorized_key:
       user: root
       state: present
       key: "{{ lookup('file', '.ssh/florian.pub') }}"

- hosts: monitoring
  roles:
    - role: nginx
    - role: certificate
      vars:
        certificate_name: monitoring
        certificate_directory: /etc/ssl
        certificate_key_usage:
          - digitalSignature
          - keyEncipherment
        certificate_extended_key_usage:
          - serverAuth
        certificate_common_name: "{{ grafana_domain }}"
    - role: jitsi-monitoring

- hosts: all
  roles:
    - role: jitsi-monitoring-client
